<!DOCTYPE html>
<meta charset="utf-8">
<body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="emojiColors.js"></script>

<img src="data:image/jpg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4gKgSUNDX1BST0ZJTEUAAQEAAAKQbGNtcwQwAABtbnRyUkdCIFhZWiAH3wAGABcAEgACABJhY3NwQVBQTAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA9tYAAQAAAADTLWxjbXMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAtkZXNjAAABCAAAADhjcHJ0AAABQAAAAE53dHB0AAABkAAAABRjaGFkAAABpAAAACxyWFlaAAAB0AAAABRiWFlaAAAB5AAAABRnWFlaAAAB+AAAABRyVFJDAAACDAAAACBnVFJDAAACLAAAACBiVFJDAAACTAAAACBjaHJtAAACbAAAACRtbHVjAAAAAAAAAAEAAAAMZW5VUwAAABwAAAAcAHMAUgBHAEIAIABiAHUAaQBsAHQALQBpAG4AAG1sdWMAAAAAAAAAAQAAAAxlblVTAAAAMgAAABwATgBvACAAYwBvAHAAeQByAGkAZwBoAHQALAAgAHUAcwBlACAAZgByAGUAZQBsAHkAAAAAWFlaIAAAAAAAAPbWAAEAAAAA0y1zZjMyAAAAAAABDEoAAAXj///zKgAAB5sAAP2H///7ov///aMAAAPYAADAlFhZWiAAAAAAAABvlAAAOO4AAAOQWFlaIAAAAAAAACSdAAAPgwAAtr5YWVogAAAAAAAAYqUAALeQAAAY3nBhcmEAAAAAAAMAAAACZmYAAPKnAAANWQAAE9AAAApbcGFyYQAAAAAAAwAAAAJmZgAA8qcAAA1ZAAAT0AAACltwYXJhAAAAAAADAAAAAmZmAADypwAADVkAABPQAAAKW2Nocm0AAAAAAAMAAAAAo9cAAFR7AABMzQAAmZoAACZmAAAPXP/bAEMACAYGBwYFCAcHBwkJCAoMFA0MCwsMGRITDxQdGh8eHRocHCAkLicgIiwjHBwoNyksMDE0NDQfJzk9ODI8LjM0Mv/bAEMBCQkJDAsMGA0NGDIhHCEyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMv/AABEIAUABQAMBIgACEQEDEQH/xAAcAAEBAAMBAQEBAAAAAAAAAAAABwEGCAUEAgP/xABMEAEAAAEFCAwLBQYHAQAAAAAAAQYHERIxBRMUF4Okw+MWQUNEVmFiZIKEo+ICBCVFUWVmlMHC4SEkMkJxAwgVUmOBIyY2VJGToqH/xAAaAQEAAwEBAQAAAAAAAAAAAAAAAgMEAQUG/8QAKREBAAIBAgUDBAMBAAAAAAAAAAECAxETBBIxMlEFFGEhM0FCFVJiof/aAAwDAQACEQMRAD8Av4AAAAAAAAAAAAAAAAAAAAAAAPzGyLjfadkRsi43ZOJ/DRw/5FlmG8/9X0qNLJMN5/6vpVeHvhbm7FmAb2IAAAAAAAAAAAAAAAAAAAAAAABiMUZx8x4N59q1m8Kxxsz57zXTRdhpFtdVkx8x4Nw9+1Zj5jwbh79q0bFG9fyv2aLJj5jwbh79qzHzHg3D37Vo2Ob1/Js0WTHzHg3D37VmPmPBuHv2rRsN6/k2aLJj5jwbh79qzHzHg3D37Vo2G9fybNFjjPxHg3n2rRwEbXm3VKtK16DcZCS7jImPj/k7DYeN3vd73UqVuTGmmtxUUbdLThyJms6wlavNGk9Fkx8x4Nw9+1Zj5jwbh79q0bFm9fyr2aLJj5jwbh79qzHzHg3D37Vo2Ob1/Js0dKSDl5GW38Q8m4Fgl73e+V69bkwooq8drdEbmHtu/wBX0qytmK02rrLLkiItMQyAsQAAAAAAAAAAAAAYjZEGKYekph6XG4y+5+Gj2/y7Jph6WKYelxuOe5+D2/y7H8KP2OOAV5MnOtx4+T8gClaAAAAAAAOgAAA6A7Ioh6GaIeho9t8s3uPhGph7bv8AV9KspYNFK8tdFFrc06sgJogAAAAAAAAAAABtADjUWTENHhJD3HWGIaPCSHuOsYNm/ht3qI2Nxl3ISMiY+IeUcMh43fNwvdSpV5Uaaa3FRRt0tOVzE1nSVlbc0awAOOgAAAAAA22RMidmOHeUMDwW97jfK1atyoUUVeOmltuJL2hzLWOTMQ5MwkorWJL2gzLWGJL2hzLWGsOc0JKK1iS9ocy1jUpbSJ2HYD5QwzCr5uN7q1avKjTTW4qKCJiXYmGpAJOuydoRrHzHg3n2rMfMeDefatt3qeWHav4WUaVIOXkZbRuh5NwOPil73e+V69bkwooq8drdVlbRaNYQmJidJZAScAAAAAAAAAAAAAAAARqfm24HWNEjSyz8W3A6xokaefm75bcPYAKloAAAAACtTJefer6RWklmS8+9X0itIT1Vz1ZAcRYSWe3zH1jRq0k09vmPrGjdjqlHVJAE1gAkLLMPbd/q+lWVGph7bv8AV9Ksrdi7IYcvfIAtVgAAAAAAAAACMz823A6xolmRmfm24HWNEqzdkrMXfCNgMOrcAAAAOtNpyW602ldkLMgIogAAAAA4AAAAAOj1QHrsYA6AAAAAAAAAAAAMNKl5IOMto3P8pYHHxS+bhfK9eryoUUVeO1uojasWjSXYmYnWEaxDR4SZjrDENHhJmOsWU2lezTwnu38uNgGJuAHAdabTkt1ptIWQsyAigADqSY7fZ7PdWY7fZ7PdWkos0hPlhWsdvs9nurMdvs9nurSUNIOWFax2+z2e6tWnJbrSCMxEOWjToNSltLbYdgPk/C8Kvm7XurVq8mNNNbioobaks9vmPrGjciNZciNZMdvs/nurMdvs9nurSUTiIS5YdlBtD1XngAAAAAAAAAAAAAMFgjU/FtwOsaJC9uWuqVa806LLTD0sUwotcbjP7n4X+3+QBnaQVqZLz51fSK0hM6SjNnJbrSBQ0VGZ1RmdW9jRHuyb3z0fiaIveAcdclDrQS5kuZyWLpObZcvK/In70+H4HdxxfmeXxPquzkmnLro0t1pBz+6AZ+M4XY0+uuq3hON91r9NND7Ulns8x9Y0atbafzm2XLyvyKeHxbuSKLuIz7GOcmmuiFjdB6n8Z/p5v81r+n/XS20MQsgyi2AAAAAAAAAAAAAAMI1PxbcDrGiWRpcvJBxltC5/lHAsEvm4XyvXq8qFFFXjppV5azaukJ45iLRMuaxZMQ0eEkPcdYYho8JMx1jHs38NW9RGwEFqtTJefOr6RWnPEiZbbDsO8n4ZhV73a91atbkxpprcVFDbcdvs/nurVzEzKExOqtNEeBjt9ns91b33NJhGYll7snN89H4vCe7JzfPR+I494BwAAT6c3zVlfkT9YJTSZ2SR8V+94Ng9fcq9atV44UUVeO1r+LL1xm3ee5wfGYseKK2l4HG8Fmy5pvSPon7oDboT/Fj64zbvKAy+ocRjy8vJLX6bw2TDzc8dSxP5zfNeV+RQGvynkzsjwX75g+D19yr1q1XjhRRV47Wfg8lceaLW6NXG47ZMM0p1R8UDFl64zbvGLH1xm3ee377B/Z4NfT8/9VU8GyDL48L5H/pnDY/yf+nm+4x+XvRjt4fZtMP4/sf219p+yijjf2WVtFo1hyY0+ksgJOAAAAAAAAAAAABtA4ONQHmvQABIXpBV6QlCw92Tm+ej8XhPdk5vno/FFB7wDgAAAAAAAAADoAaOPp8T/P8A2fY+PxP8/wDZ9j08HZDNk7pAFyAAAAAAAAAAAjM/NtwOsaJZkZn5tuB1jRKs3ZKzF3wjYDDDY7KDaHpPPRqfi24HWNEjSyz823A6xokaYM3fLbh7BekFXlTKVmQEUQAcb2A4PBlHvbpfB4T3ZR726XweE6AAAAAAKgA9bRjAEgAAAAAAAAAAABhpUvJBxlvG5/lLA4+KXzcL5Xr1eVCiirx2t1EbVi0aS7EzE6wjWIaPCTMdYYho8JMx1iyiGzTwnu38sgLVbSZeSDjLaFz/ACjgWCXzcL5Xr1eVCiirx00tPxDR4SQ9x1iyMq5xVtOspxktEaRKNYho8JIe46xvmxDn0P8Ap7zaRGcOPwbl5/LVtiEf992PeeXde5P8Jj+xhf77fa35KtFFHHGm1vrVpX7y6fyqsuKlaTMQlS9ptETLWQGJe93ZHzTtPobI+adp9HhBoPd/1Bze8dKtW/4ooo/+mxznfZ/Uk3vno/F7wPB2Oc67P6mxznXZ/V7o5q68LY5zrs/qbHOddn9XuhqPC2Oc67P6mxznXZ/V7oajy9mHMe17psw5j2vdayL9/J5V7dW83HuxG61+/wAC9Xqr+etTTTxQ9D1mryP350PmbRD7W3FabUiZUXiItoyAtRAAAAAAAAAAAAAAAABMJ37bjZfRpiDp0cxAOnWrSx3n0/lQtRJrvO2R+dTxH25Tx90PpG9jzdWlog3sNR4Mm989H4veeDKTe3S+Dwgb2NEDQb2NEDQb2NEDQGFPogzQ2e1+VO98NXkfvzofM2gZacdeSvKqtOs6gCbgAAAAAAAAAAAAAAJjjf8AUed9wxv+o877gMTv23Gy+jTFs0rpXbKo+J/csFwa+btfK1aryYUUVeO1rIAACiTXWXWyPzp29G5UvNhF+8m4ZhdXd73UqU8mNNNbioo26VWaJmkxC3DWbX0jquwjePiPBvPdWY+I8G891bztuzdsZPCyCN4+PZvPtWY+PZvPtWbdnNjJ4UeUe9vt/m+Dwmj3Snn/AIhevIF7vdO/KaaaP6cPQ+DGr6lzruO7djYyeFHE4xq+pc67jYdl/Me17rsYbz0V5Kzj7mzDWdl3Me17rZZI/wCasM+zBcGvf9StWrfpRRV47Uvb5PCrcqyNm2H8+7LvM7D+fdl3jYyeDcq2kB6TMAAAAAAAAAAAAAAAAAA5iAAAAAAa/KfenT+VsDX5T706fyoX7WnhPvVa+AzvcABwAAUBPlBXYnm+ofqKdNBbdnIaRMVOmgtuzkNIteap4AAAAAAAAAAAAAAAAAAAAAAAJhO/bcbL6NMVOnftuNl9GmIDp1zE6dBhEP3hPxyd6zolvRD94T8cnOs6JC/a0cL96qJAM73QAcAAYdueB+CH6OI3bngfgh+i7E8z1DrV+kwnftuNl9Gp6YTv23Gy+jWvOTEAHToAAAAAAAAAAAAAAAAAAAJjjf8AUed9wxv+o877iYANmldK7ZVHxP7lguDXzdr5WrVeTCiirx2tZABT8b3qPO+4mACnY3fUed9xo04N2oy7jc6N4wHA77+e+169Xi8Giirx007VDygmImNJSpaaWi1esNf2Mc87L6mxjnnZfVsAhyVaI4vL5T8Bne1UABh254H4Ifo4jdueB+CH6LsTzPUOtX6TCd+242X0anphO/bcbL6Na85MQAU/G/6jzvuGN/1HnfcTABc5IyvjKqPjv3HBcGqbtfK1atyYUUVeO1tSYTQW3ZyGkU8AAAAAAAAAAAAAAAAHMQAAp00Ft2chpFPBzEOnXMQAAAA7XuT8BkfRV6AA6w7c8D8EP0cRqCuxPN9Q/V06mE79txsvo0xU6aC27OQ0i15qYjp0BzEACnTQW3ZyGkU9MJoLbs5DSKeAAAAAAAAAAAAAAAADmIAFOmgtuzkNIp6YTQW3ZyGkU8BzE6dcxAAAADte5PwGR9FXoADrCgp8oK7E831D9RTpoLbs5DSJip00Ft2chpFrzVPABzEACnTQW3ZyGkU9MJoLbs5DSKeAAAAAAAAAAAAAAAADmIAFOmgtuzkNIp6YTQW3ZyGkU8BzE6dcxAAAADte5PwGR9FXoADrCgp8oK7E831D9RTpoLbs5DSJip00Ft2chpFrzVPABzEACnTQW3ZyGkU9MJoLbs5DSKeAAAAAAD//2SAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA="/>
<BR>
<script>

emojiMap = loadEmojis();
emojiInts = emojiPoints();
function loadEmojis(){
	var colorMap = {};
	for (var i=0; i<emojiColors.length; i++){
		fileNumber = pad(i+1 , 4);
		img = 'emoji-images/' + fileNumber + '.png';
		colorMap[emojiColors[i]] = img
	}
	return colorMap;
}
function pad(num, size){ return ('000' + num).substr(-size); }
var closestEmoji = function(color) {
	var distance = 99999999;
	var c, d, p;
	for (var i=0; i<emojiInts.length; i++){
		p = emojiInts[i];
		d = Math.sqrt( Math.pow((color[0]-p[0]), 2) + Math.pow((color[1]-p[1]), 2) + Math.pow((color[2]-p[2]), 2) );
		if (d < distance){
			distance = d;
			c = p[3];
		}
	}
	return emojiMap[c];
}

function emojiPoints(){
	var pointArray = [];
	var c, r, g, b;
	for (var i=0; i<emojiColors.length; i++){
		c = emojiColors[i];
		r = parseInt("0x"+c.substr(1,2));
		g = parseInt("0x"+c.substr(3,2));
		b = parseInt("0x"+c.substr(5,2));
		pointArray.push([r, g, b, c]);
	}
	return pointArray;
}

var img = document.querySelector('img');
var canvas = document.createElement('canvas');
canvas.width = img.width;
canvas.height = img.height;
var canvasContext = canvas.getContext('2d');
canvasContext
	.drawImage(img, 0, 0, canvas.width, canvas.height );
var x = canvasContext.getImageData(0,0,1,1);

var scaleUpBy = 2,
		margin = 100;

var width = img.width * scaleUpBy + margin * 2,
		height = img.height * scaleUpBy + margin * 2,
		centerX = 0.5 * width,
		centerY = 0.5 * height,
		bigCircleRadius = 300;

var sample = poissonDiscSampler(width, height, 12);

var svg = d3.select("body").append("svg")
		.attr("width", width)
		.attr("height", height);

d3.timer(function() {
	// Make multiple runners?
	for (var i = 0; i < 100; ++i) {
		var s = sample();
		if (!s) return true;
		// can we map a point onto the image?
		if ( s[0] < margin || s[1] < margin ) {
			return;
		}
		// get rgb value of point
		var rgb = canvasContext.getImageData(Math.round( ( s[0] - margin ) / scaleUpBy ), Math.round( ( s[1] - margin ) / scaleUpBy ), 1, 1);
		if ( s[0] > width - margin || s[1] > height - margin ) {
			return ;
		}
		var closest = closestEmoji( [ rgb.data[0], rgb.data[1], rgb.data[2] ] );
		svg.append("image")
				.attr("x", ( s[0] - 10 )  )
				.attr("y", ( s[1] - 10 )  )
				.attr("height", 30 )
				.attr("width", 30 )
				.attr( 'transform', 'rotate('+ ( Math.ceil( Math.random() * 360 ) ) + ',' + ( s[0] +5 ) + ',' + ( s[1] +5 ) + ')')
				.attr('xlink:href', closest );
	}
});

/**
 * Returns a function.
 *
 * Based on https://www.jasondavies.com/poisson-disc/
 * @param radius Radius of the sampling circles?
 */
function poissonDiscSampler(width, height, radius) {
	// Maximum number of samples before rejection.
	var k = 30,
			radius2 = radius * radius,
			R = 3 * radius2,
			cellSize = radius * Math.SQRT1_2,
			gridWidth = Math.ceil(width / cellSize),
			gridHeight = Math.ceil(height / cellSize),
			// create an arrayÂ containing every pixel in the grid.
			// Index = y * gridWidth + x (i.e. read pixels left to right like a book).
			grid = new Array(gridWidth * gridHeight),
			queue = [],
			queueSize = 0,
			sampleSize = 0;

	/**
	 * Returns a good point.
	 *
	 * @return {[type]} [description]
	 */
	return function() {
		// If there are no samples yet (first time through), create a sample in the middle.
		if (!sampleSize) {
			return sample(width / 2, height /2 );
		}

		while (queueSize) {
			// Pick a random existing sample and remove it from the queue.
			var i = Math.random() * queueSize | 0,
					s = queue[i];

			// Make a new candidate between [radius, 2 * radius] from the existing sample.
			for (var j = 0; j < k; ++j) {
				var a = 2 * Math.PI * Math.random(),
						r = Math.sqrt(Math.random() * R + radius2),
						x = s[0] + r * Math.cos(a),
						y = s[1] + r * Math.sin(a);

				var distFromCenter = Math.sqrt( ( centerX - x ) * ( centerX - x ) + ( centerY - y ) * ( centerY - y ) );
				// Reject candidates that are outside the allowed extent,
				// or closer than 2 * radius to any existing sample.
				if (0 <= x && x < width && 0 <= y && y < height && far(x, y) ) {
					return sample(x, y);
				}
			}

			queue[i] = queue[--queueSize];
			queue.length = queueSize;
		}
	};

	/**
	 * Whether a coordinate is far enough from other existing points.
	 *
	 * @param  {[type]} x [description]
	 * @param  {[type]} y [description]
	 * @return {[type]}   [description]
	 */
	function far(x, y) {
		var i = x / cellSize | 0,
				j = y / cellSize | 0,
				i0 = Math.max(i - 2, 0),
				j0 = Math.max(j - 2, 0),
				i1 = Math.min(i + 3, gridWidth),
				j1 = Math.min(j + 3, gridHeight);

		for (j = j0; j < j1; ++j) {
			var o = j * gridWidth;
			for (i = i0; i < i1; ++i) {
				if (s = grid[o + i]) {
					var s,
							dx = s[0] - x,
							dy = s[1] - y;
					if (dx * dx + dy * dy < radius2) return false;
				}
			}
		}

		return true;
	}

	/**
	 * Add a sample to the global stores.
	 *
	 * @param  {Number} x
	 * @param  {Number} y
	 * @return {Array}
	 */
	function sample(x, y) {
		var s = [x, y];
		// Push the point onto the queue.
		queue.push(s);
		//
		grid[gridWidth * (y / cellSize | 0) + (x / cellSize | 0)] = s;
		++sampleSize;
		++queueSize;
		return s;
	}
}

</script>
